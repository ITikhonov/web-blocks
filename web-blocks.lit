


		Block coordinates

	Each block is rectangular area, which have top,
	left, bottom and right coordinates relative to
	page.

	So at the very core each block looks like:

=test-block-basic
-		page = { 
-			top:		20,
-			left:		20, 
-			bottom:		1010, 
-			right:		700, 
-		}

-		page.block1 = { 
-			top:		10,
-			left:		20, 
-			bottom:		20, 
-			right:		40, 
-		}


	But in real life block coordinates can't be defined
	directly, as they are function of content (text size)
	or environment (font, viewport size).

	So block coordinates are mostly specified in terms of
	relation to other blocks.


=test-block-relative
-		page = { 
-			top:		20,
-			left:		20, 
-			bottom:		1010, 
-			right:		700, 
-		}

-		page.block1 = {
-			top:	'page.top',
-			left:	'page.left + 20',
-			bottom:	'page.block1.top + 100',
-			right:	'page.block1.left + 120',
-		}

-		page.block2 = {
-			top:	'page.block1.bottom',
-			left:	'page.block1.right',
-			bottom:	'page.block2.top + 50',
-			right:	'page.block2.left + 75',
-		}

	Position of block2 depends on block1 position and size.


		Block content

	For some blocks their content is used to determine bottom
	and right coordinates.

	For each block content.bottom and content.right specifies
	maximum bottom and right coordinates of blocks it includes.

=test-block-content
-		page = { 
-			top:		20,
-			left:		20,
-			bottom:		'page.contentBottom',
-			right:		700,
-		}

-		page.block1 = {
-			id: 'page.block1',
-			top:	'page.top + 20',
-			left:	'page.left + 20',
-			bottom:	'page.block1.contentBottom + 20',
-			right:	'page.block1.contentRight + 30',
-		}

-		page.block1.block2 = {
-			id: 'page.block1.block2',
-			top:	'page.block1.top + 20',
-			left:	'page.block1.left + 30',
-			bottom:	'page.block1.block2.top + 20',
-			right:	'page.block1.block2.left + 30',
-		}

		Walking

=each-block
-function each_block(block,func) {
-	for(var k in block) {
-		if(k[0]=='_') continue;
-		if(block.__lookupGetter__(k)) continue;
-		if(typeof block[k]!='object') continue;
-		func(block[k]);
-	}
-}

		Wrap coordinates

	Retrieving left/right/top/bottom should try to evaluate it's value,
	so we define getters.

=wrap-block
-function wrap_coordinate(block,name) {
-	block['_'+name]=block[name];
-	block.__defineGetter__(name,function() {
-		var r=eval_coord(this['_'+name]);
-		wrap_coordinate.depth--;
-		return r;
-	});
-}

-function wrap_block(block) {
-	wrap_coordinate(block,'left');
-	wrap_coordinate(block,'top');
-	wrap_coordinate(block,'right');
-	wrap_coordinate(block,'bottom');

-	block.__defineGetter__('contentBottom',function() {
-		var maximum=0;
-		each_block(this,function(b) {
-			var y=b._el.offsetTop+b._el.offsetHeight-2;
-			if(y>maximum) maximum=y;
-		});
-		return maximum;
-		
-	});

-	block.__defineGetter__('contentRight',function() {
-		var maximum=0;
-		each_block(this,function(b) {
-			var x=b._el.offsetLeft+b._el.offsetWidth-2;
-			if(x>maximum) maximum=x;
-		});
-		return maximum;
-		
-	});

-	each_block(block,wrap_block);
-}


		Evaluating coordinates

	Converting relative coordinates into absolute

=eval-coord
-function eval_coord(expr) {
-	if(typeof expr == 'string') {
-		return eval(expr);
-	} else {
-		return expr;
-	}
-}

=bake-block
-function bake_block(block) {
-	each_block(block,bake_block);
-	block._el=document.createElement('div');
-	block._el.className='apos';
-	block._el.id=block.id;
-	block._el.style.top	=block.top;
-	block._el.style.left	=block.left;
-	block._el.style.width	=block.right - block.left;
-	block._el.style.height	=block.bottom - block.top;
-	document.body.appendChild(block._el);
-}

=>main.js
(function()
>each-block
>eval-coord
>wrap-block
>bake-block

-function run() { wrap_block(page); bake_block(page); }
-window.onload=run;

)();

=test-html-pre
-<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><style>.apos{position:absolute;margin:0;padding:0;border:1px solid black;overflow:hidden}</style></head><script>

=test-html-post
-</script><script src="../main.js"></script><body></body></html>

=>test/basic.html
>test-html-pre
>test-block-basic
>test-html-post


=>test/relative.html
>test-html-pre
>test-block-relative
>test-html-post

=>test/content.html
>test-html-pre
>test-block-content
>test-html-post
 
